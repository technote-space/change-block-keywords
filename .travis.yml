language: php

sudo: false
dist: trusty

notifications:
  email: false
  slack:
    rooms:
      - secure: TVEH5/HaPGVRIq5rHjuXu01OsEnqycqk1Yalo92toreTF/pe+YvqrCf/unHoweDn62Gc8RWr+mxzA1Tvruz9MfyXXZz9VsaEe2h6Qu/QySMkbRxlj8zZwDBENye9Ryo/1kOZecL4i7AsAZdL9vLGQI1iIP5IbVja6GAFOY+x9Jrp5G6yJdPHmEdYhJWjH6Mqr/cjew9AQiQHb1G2guOmqoCVDwBy3Kf2hwPzA+gJuTWOgObwBRa+VQ8RgB6QrFEmmA1omrPJmPgMXK8qX0ALWJwaZjuuE64tTdhSZ65BebZoU95jklwlGhRdFAORlwtTnc5xFVDNyRX+/PyriJ4iWYFkSk035HBphPdr+p3AO+9Y9bSXUeITNBwI834UvC/wuG+ODbtNTYFn0w0Bl7G2RPmHTrZwKHqc7YcHSEP6hZxAYrP7Jt+tbfcogVMUNkQoykUbdPKAeF5Ny+2+UG78P9cuXwP3pcVORotxYeuBPrGXfOA/0RfFo/AJd7yaq3Cyj875uCk4fQdkbCxnbQ3IlzHjADMLpri3k+vRIJfogh/inyAgS/zVIiXDkN2TtQyzkRJp2QQeH984Z7J2Y3xCYfbsRPAlRHOBQvXofo2o/yE+RUTj713kVQLg8i28lpxeA64zwFboI9XtqPvFjHO4UF1uxbhJvSFbggALyKgtT9M=

branches:
  only:
    - master
    - "/^v[0-9\\.]+/"

cache:
  directories:
    - "$HOME/.composer/cache"
    - "$HOME/.npm"

stages:
  - name: check
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: test
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: prepare
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: deploy
    if: tag IS present

jobs:
  fast_finish: true
  include:
    - stage: check
      language: php
      php: '7.2'
      script: bash tests/bin/php/phpcs.sh
    - stage: check
      language: php
      php: '7.2'
      script: bash tests/bin/php/phpmd.sh

    - stage: check
      language: node_js
      node_js: '11'
      dist: trusty
      script: bash tests/bin/js/js-lint.sh


    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env: WP_VERSION=latest
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env:
        - WP_VERSION=5.2
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env: WP_VERSION=latest
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env:
        - WP_VERSION=5.1
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=5.0
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=5.0
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=trunk
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=4.9
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=3.9
      script: bash tests/bin/php/wp-test.sh

    - stage: test
      language: node_js
      node_js: '10'
      dist: trusty
      script: bash tests/bin/js/js-test.sh
    - stage: test
      language: node_js
      node_js: '11'
      dist: trusty
      env: COVERAGE_REPORT=1
      script: bash tests/bin/js/js-test.sh


    - stage: prepare
      language: node_js
      node_js: '11'
      dist: trusty
      script:
        - source tests/bin/deploy/env.sh &&  bash tests/bin/deploy/wp-check-diff.sh


    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy:
        - source tests/bin/deploy/env.sh && bash tests/bin/deploy/create.sh
      deploy:
        provider: releases
        skip_cleanup: true
        name: ${RELEASE_TITLE}
        tag_name: ${RELEASE_TAG}
        draft: true
        api_key:
          secure: KFNBCetVG10nva5ftfGC6ioEIYtgJFm5YU+3svs5PPfs0B2pN//X1jgGwagXywleZqoB8ZSl+tCk/7dRM2jdAKmSggO3EMtTpI47gqjYQqlm6U+ecmxdICfSzMtJiqG+8VdnarnkVRyCEW1VAYUBNnf1fWkd/ghi+aUoQMK3iODwrMD60Y1ISdmQxrXxJuRaSjs0zCMLI/hdNka2R9uxbbJDbyqIf4Ga5kkJz29ML5cox7AyIc66z+HTw48mC+gVj8rtEF0SE6hUVFUIbwABv8Q3alRhoFd+JqRoKrYYWC20sTYfpr6Fdc63JkABCaXP5Z9kbk9fWkdS/s3+KSG/z4zFnLlv79eed2KBnKbFlNVSp/3u8rXdC9o4pzDBsmTRQyZ+mR0o9IICRqfOLqVVZvAWfNJBCFN8iIHtADs9ClZ5BK8yjGmR0LF+IllmuDxyz7BgstPPfD0uJoSP45VOwATcEEW5dPtCpagI2x3l8QAk8bfJZsP6xIFU58hcT/gCtFnaurWFCB1npNxRVWqobp7Bqz22cUkDRfcLCCYaMXyzcKRTBGDJFp+M5RH+6Hxqy2+HUb4DoW+cejudEV+Z6YaNXtTeqiTyQka9YatSfCJzJbLtBUAWEdt3Sif+mfM/ZU9jF+rDtr9jekxwfqprBZhxVdSzBonzbdfVhTluH5A=
        file: ${RELEASE_FILE}
        overwrite: true
        on:
          tags: true

    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy:
        - source tests/bin/deploy/env.sh
      deploy:
        provider: script
        skip_cleanup: true
        script: bash tests/bin/deploy/wp-release.sh
        on:
          tags: true

  allow_failures:
    - env: WP_VERSION=4.9
    - env: WP_VERSION=3.9
